const https = require('https');
const http = require('http');
const express = require('express');
const bodyParser = require('body-parser');
const fs = require('fs');
var debug = require('debug')('chatbottest:server');
const config = require('../config');
const reply = require('../reply');
const actionBasic = require('../action/basic');
const actionConcierge = require('../action/concierge');
const actionNtConcierge = require('../action/ntConcierge');
const actionHelp = require('../action/help');
const actionEnjoy = require('../action/enjoy');
const actionScheduler = require('../action/scheduler');
const requestSender = require('request');

var app = express();




var session = require('express-session');


app.use(session({
    secret:'@#@$MYSIGN#@$#$',
    resave:false,
    saveUninitialized: true
}));




var port = normalizePort(process.env.PORT || '3000');


app.set('port', port);


var server = http.createServer(app);

/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);


app.use(bodyParser.json());

app.get('/', function(req, res, next) {

    var sess = req.session;

    if (sess.views) {

        sess.views++
        res.setHeader('Content-Type', 'text/html')
        res.write('<p>views: ' + sess.views + '</p>')

        res.write('<p>expires in: ' + (sess.cookie.maxAge / 1000) + 's</p>')
        res.end()
    } else {
        sess.views = 1
        res.end('welcome to the session demo. refresh!')
    }
});


var defaultResponse = {
    success: true,
    resultCode: "00",
    resultMessage: "success"
};
var ntSession;
var ii = 0;
app.post('/naverTalkTalk', function (req, res) {

    if(ntSession === null || ntSession === '' || ntSession === undefined){
        ntSession = req.session;
        ntSession.username = [];
        ntSession.username[ii] = req.body.user;
        ntSession.concierge = [];
        ntSession.concierge[ii] = false;
        ntSession.spaces1 = [];
        ntSession.spaces1[ii] = false;
        ntSession.spaces2 = [];
        ntSession.spaces2[ii] = false;
        ntSession.spaces3 = [];
        ntSession.spaces3[ii] = false;
        ntSession.specialtyRangeYN = [];
        ntSession.specialtyRangeYN[ii] = false;
        ntSession.spaceBrandingYN = [];
        ntSession.spaceBrandingYN[ii] = false;
        ntSession.spaceMeasure = [];
        ntSession.spaceMeasure[ii] = false;
        ntSession.budget = [];
        ntSession.budget[ii] = false;
        ntSession.stylesYN = [];
        ntSession.stylesYN[ii] = false;

        ntSession.estimate_Type = "interior";
        ntSession.spacesCategory = [];
        ntSession.spacesSubCategory = [];
        ntSession.spacesSpace = [];
        ntSession.specialtyRange = [];
        ntSession.spaceBranding = [];
        ntSession.py = [];
        ntSession.meter = [];
        ntSession.budgetMin = [];
        ntSession.budgetMax = [];
        ntSession.styles = [];
        ntSession.history = [];

        ntSession.errorStatus = [];
        ntSession.errorStatus[ii] = false;

    }else{
        //세션새로 생성
        if(ntSession.username[ii] === null || ntSession.username[ii] === '' || ntSession.username[ii] === undefined){
            ntSession.username[ii] = req.body.user;
        }else{

            if(req.body.user !== ntSession.username[ii]){
                for(var j = 0; j<ntSession.username.length; j++){
                    //세션 변경
                    if(ntSession.username[j] ===  req.body.user) {
                        //기존 세션
                        ii = j;
                        break;
                    }else{
                        //바뀌는 세션
                        ntSession.username[ii+1] = req.body.user;
                        ii++;
                        break;
                    }
                }
            }else{

            }

        }
    }

    console.log(req.body);

    var textResponse = {
        success: true,
        resultCode: "00",
        resultMessage: "success",
        request: {
            event: "send",
            sender: "partner",
            user : req.body.user,
            partner: req.body.partner,
            textContent :{}
        }
    };
    var imgResponse = {
        success: true,
        resultCode: "00",
        resultMessage: "success",
        request: {
            event: "send",
            sender: "partner",
            user : req.body.user,
            partner: req.body.partner,
            imageContent :{}
        }
    };

    switch(req.body.event) {
        case 'send' :
            if(req.body.sender == 'user' && req.body.textContent) {
            var text = req.body.textContent.text;

                if(text.indexOf("컨시어지") != -1){

                    ntSession.concierge[ii] = true;
                    ntSession.spaces1[ii] = true;
                    res.json(actionNtConcierge.getConciergeExpress("spaces1",req.body,''));

                }else {
                    //에러발생시
                    if (ntSession.errorStatus[ii] === true) {
                        var code = req.body.textContent.code;
                        ntSession.errorStatus[ii] = false;
                        res.json(actionNtConcierge.getConciergeExpress(code, req.body, ''));
                    } else {
                    //컨시어지 시작
                    if (ntSession.concierge[ii] === true) {

                        //공간선택
                        if (ntSession.spaces1[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("spaces1", req.body, ''));
                                ntSession.spaces1[ii] = true;
                                ntSession.spaces2[ii] = false;
                            } else {
                                var code = req.body.textContent.code;

                                //텍스트로 입력시 처리
                                if (code === undefined) {
                                    if (!isNaN(text)) {
                                        if (text > 0 && text <= 5) {
                                            code = text;
                                        }
                                    } else {

                                        var result = actionNtConcierge.getSpaces1(text);

                                        //에러
                                        if (result == '-1') {

                                            res.json(actionNtConcierge.getConciergeExpress("back", req.body, 'spaces1'));
                                            ntSession.errorStatus[ii] = true;
                                            ntSession.spaces1[ii] = true;
                                            ntSession.spaces2[ii] = false;

                                            return false;
                                        } else {
                                            code = result;
                                        }

                                    }
                                }

                                ntSession.spacesCategory[ii] = code;
                                res.json(actionNtConcierge.getConciergeExpress("spaces2", req.body, code));
                                ntSession.spaces1[ii] = false;
                                ntSession.spaces2[ii] = true;
                            }


                            //업종선택
                        } else if (ntSession.spaces2[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("spaces1", req.body, ''));
                                ntSession.spaces1[ii] = true;
                                ntSession.spaces2[ii] = false;
                            } else {
                                var result = actionNtConcierge.getSpaces2(ntSession.spacesCategory[ii], text);

                                if (result !== undefined) {
                                    ntSession.spacesSubCategory[ii] = result;
                                    var params = [];
                                    params[0] = ntSession.spacesCategory[ii];
                                    params[1] = result;
                                    ntSession.history[ii] = params;

                                    res.json(actionNtConcierge.getConciergeExpress("spaces3", req.body, params));

                                    ntSession.spaces2[ii] = false;
                                    ntSession.spaces3[ii] = true;
                                } else {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, params));
                                }

                            }

                            //상세 업종선택
                        } else if (ntSession.spaces3[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("spaces2", req.body, ntSession.spacesCategory[ii]));
                                ntSession.spaces2[ii] = true;
                                ntSession.spaces3[ii] = false;
                            } else {
                                var result = actionNtConcierge.getSpaces3(ntSession.spacesCategory[ii], ntSession.spacesSubCategory[ii], text);

                                ntSession.spacesSpace[ii] = result;

                                res.json(actionNtConcierge.getConciergeExpress("specialtyRange", req.body, ''));
                                ntSession.spaces3[ii] = false;
                                ntSession.specialtyRangeYN[ii] = true;
                            }

                            //범위선택
                        } else if (ntSession.specialtyRangeYN[ii] === true) {

                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("spaces3", req.body, ntSession.history[ii]));
                                ntSession.spaces3[ii] = true;
                                ntSession.specialtyRangeYN[ii] = false;
                            } else {

                                var code = req.body.textContent.code;
                                var result = actionNtConcierge.getSpecialtyRange(code);

                                ntSession.specialtyRange[ii] = result;

                                ntSession.specialtyRangeYN[ii] = false;

                                if (ntSession.specialtyRange[ii][0] === 'interiorFull' || ntSession.specialtyRange[ii][0] === 'interiorDesign') {
                                    ntSession.spaceBrandingYN[ii] = true;
                                    res.json(actionNtConcierge.getConciergeExpress("spaceBranding", req.body, ''));

                                } else {
                                    ntSession.spaceMeasure[ii] = true;
                                    res.json(actionNtConcierge.getConciergeExpress("spaceMeasure", req.body, ''));

                                }
                            }

                            //공간브랜딩 선택
                        } else if (ntSession.spaceBrandingYN[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("specialtyRange", req.body, ''));
                                ntSession.specialtyRangeYN[ii] = true;
                                ntSession.spaceBrandingYN[ii] = false;
                            } else {
                                if (text.indexOf("네") != -1) {
                                    ntSession.spaceBranding[ii] = true;
                                } else {
                                    ntSession.spaceBranding[ii] = false;
                                }

                                res.json(actionNtConcierge.getConciergeExpress("spaceMeasure", req.body, ''));

                                ntSession.spaceBrandingYN[ii] = false;
                                ntSession.spaceMeasure[ii] = true;
                            }

                            //면적 선택
                        } else if (ntSession.spaceMeasure[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("specialtyRange", req.body, ''));
                                ntSession.specialtyRangeYN[ii] = true;
                                ntSession.spaceMeasure[ii] = false;
                            } else {
                                var result = actionNtConcierge.getMeasure(text);

                                ntSession.py[ii] = result[0];
                                ntSession.meter[ii] = result[1];

                                res.json(actionNtConcierge.getConciergeExpress("budget", req.body, ''));

                                ntSession.spaceMeasure[ii] = false;
                                ntSession.budget[ii] = true;
                            }

                            //예산선택
                        } else if (ntSession.budget[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("spaceMeasure", req.body, ''));
                                ntSession.spaceMeasure[ii] = true;
                                ntSession.budget[ii] = false;
                            } else {
                                var result = [];
                                var msg = text;
                                msg = msg.trim();
                                var pattern = /\s/g; // 공백여부

                                if (msg.indexOf("~") != -1) {
                                    result = msg.split("~");
                                    ntSession.budgetMin[ii] = result[0];
                                    ntSession.budgetMax[ii] = result[1];
                                } else if (msg.indexOf(",") != -1) {
                                    result = msg.split(",");
                                    ntSession.budgetMin[ii] = result[0];
                                    ntSession.budgetMax[ii] = result[1];
                                } else if (msg.match(pattern)) {
                                    result = msg.split(" ");
                                    ntSession.budgetMin[ii] = result[0];
                                    ntSession.budgetMax[ii] = result[1];
                                } else if (msg.match(/[0-9]/)) {
                                    ntSession.budgetMin[ii] = msg;
                                    ntSession.budgetMax[ii] = msg;
                                } else {
                                    ntSession.budgetMin[ii] = 0;
                                    ntSession.budgetMax[ii] = 100000;
                                }

                                res.json(actionNtConcierge.getConciergeExpress("styles", req.body, ''));

                                ntSession.budget[ii] = false;
                                ntSession.stylesYN[ii] = true;
                            }

                            //스타일선택
                        } else if (ntSession.stylesYN[ii] === true) {
                            if (text.indexOf("이전") != -1) {
                                res.json(actionNtConcierge.getConciergeExpress("budget", req.body, ''));
                                ntSession.budget[ii] = true;
                                ntSession.stylesYN[ii] = false;
                            } else {
                                var result = actionNtConcierge.getStyles(text);

                                ntSession.styles[ii] = result;

                                var formData = {};
                                formData.specialty = {};
                                formData.specialty.main = "interior";
                                formData.specialty.sub = ntSession.specialtyRange[ii];
                                formData.spaces = {};
                                formData.spaces.category = ntSession.spacesCategory[ii];
                                formData.spaces.subcategory = ntSession.spacesSubCategory[ii];
                                formData.spaces.space = ntSession.spacesSpace[ii];
                                formData.spaceBranding = ntSession.spaceBranding[ii];
                                formData.measure = {};
                                formData.measure.meter = ntSession.meter[ii];
                                formData.measure.py = ntSession.py[ii];
                                formData.budget = {};
                                formData.budget.min = ntSession.budgetMin[ii];
                                formData.budget.max = ntSession.budgetMax[ii];
                                formData.style = ntSession.styles[ii];

                                ntSession.stylesYN[ii] = false;
                                ntSession.concierge[ii] = false;


                                if (!formData.specialty.main
                                    || ( !(formData.specialty.main === 'interior') && !(formData.specialty.main === 'construction'))) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                if (!formData.spaces.category || !formData.spaces.space || !formData.spaces.subcategory) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                if (!formData.specialty.sub.length) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                if ((!formData.measure.meter) || (!formData.measure.py)
                                    || !(formData.measure.meter > -1)) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                if ((!formData.budget.min) || (!formData.budget.max)
                                    || !(formData.budget.min > -1) || !(formData.budget.max > -1)
                                    || (parseInt(formData.budget.min) > parseInt(formData.budget.max))) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                if (!formData.style) {
                                    res.json(actionNtConcierge.getConciergeExpress("error", req.body, ''));
                                    return false;
                                }
                                formData.status = "NAVER_TALK";
                                var experts = null;
                                var options = {
                                    url: 'https://interiorbrothers.com/api/doConcierge',
                                    method: 'POST',
                                    json: formData
                                };

                                requestSender(options, function (error, response, body) {
                                    if (error) {
                                        return console.error('experts failed:', error);
                                    }
                                    experts = body.experts;
                                })


                                setTimeout(function () {
                                    res.json(actionNtConcierge.getConciergeExpress("experts", req.body, experts));
                                }, 1000);

                            }

                        } else {
                            textResponse.request.textContent.text = 'echo: ' + req.body.textContent.text;
                            res.json(textResponse);
                        }

                    } else {
                        textResponse.request.textContent.text = 'echo: ' + req.body.textContent.text;
                        res.json(textResponse);
                    }
                }//not err

                }

            } else {
                res.json(defaultResponse);
            }
            break;
        case 'open' :
            switch(req.body.options.inflow) {
                case 'list' :
                    textResponse.request.textContent.text = "안녕하세요. 브라더스 컨시어지를 시작하시려면 '컨시어지' 라고 입력해주세요!  ";
                    res.json(textResponse);
                    break;
                case 'none' :

                  /*  textResponse.request.textContent.text = '화면을 갱신하셨네요.';

                    res.json(textResponse);

                    imgResponse.request.imageContent.imageUrl = "https://interiorbrothers.com/img/main/qualityPortfolios.png";
                    imgResponse.request.imageContent.height = 300;
                    imgResponse.request.imageContent.width = 300;
                    res.json(imgResponse);
                   */
                    res.json(defaultResponse);
                    break;
                default:
                    res.json(defaultResponse);
            }
            break;
        case 'friend' :
            if(req.body.options.set == 'on') {
                textResponse.request.textContent.text = '인집사: 친구가되어주셔서 감사합니다.';
                res.json(textResponse);
            } else if(req.body.options.set == 'off') {
                textResponse.request.textContent.text = '인집사: 다음번에 꼭 친구추가 부탁드려요.';
                res.json(textResponse);
            } else {
                res.json(defaultResponse);
            }
            break;
        default:
            res.json(defaultResponse);
    }

});


app.get('/hook', function (reqeust, response) {
    response.writeHead(200, {'Content-Type' : 'text/html'});
    response.end('<h1>chatbot - skwjdgn@naver.com<h1>');
});

var sess;
var i = 0;
app.post('/hook', function (request, response) {
    if(sess === null || sess === '' || sess === undefined){
        sess = request.session;
        sess.username = [];
        sess.username[i] = null;
        sess.concierge = [];
        sess.concierge[i] = false;
        sess.spaces1 = [];
        sess.spaces1[i] = false;
        sess.spaces2 = [];
        sess.spaces2[i] = false;
        sess.spaces3 = [];
        sess.spaces3[i] = false;
        sess.specialtyRangeYN = [];
        sess.specialtyRangeYN[i] = false;
        sess.spaceBrandingYN = [];
        sess.spaceBrandingYN[i] = false;
        sess.spaceMeasure = [];
        sess.spaceMeasure[i] = false;
        sess.budget = [];
        sess.budget[i] = false;
        sess.stylesYN = [];
        sess.stylesYN[i] = false;

        sess.estimate_Type = "interior";
        sess.spacesCategory = [];
        sess.spacesSubCategory = [];
        sess.spacesSpace = [];
        sess.specialtyRange = [];
        sess.spaceBranding = [];
        sess.py = [];
        sess.meter = [];
        sess.budgetMin = [];
        sess.budgetMax = [];
        sess.styles = [];


    }else{

    }

    var eventObj = request.body.events[0];
    var source = eventObj.source;
    var message = eventObj.message;


    // request log
    console.log('======================', new Date() ,'======================');
    console.log('[request]', request.body);
    console.log('[request source] ', eventObj.source);
    console.log('[request message]', eventObj.message);

    if(message.type == "text" && message.text.indexOf("인집사") != -1){

        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionBasic.getBasicExpress());
    }
    else if(message.type == "text" && message.text.indexOf("인집사") === -1){

        if(message.text.indexOf("컨시어지") != -1){
            //세션새로 생성
            if(sess.username[i] === null || sess.username[i] === '' || sess.username[i] === undefined){
                sess.username[i] = eventObj.source.userId;
            }else{

                if(eventObj.source.userId !== sess.username[i]){
                    for(var j = 0; j<sess.username.length; j++){
                        //세션 변경
                        if(sess.username[j] ===  eventObj.source.userId) {
                            //기존 세션
                            i = j;
                            break;
                        }else{
                            //바뀌는 세션
                            sess.username[i+1] =  eventObj.source.userId;
                            i++;
                            break;
                        }
                    }
                }else{

                }
               
            }
            sess.concierge[i] = true;
            sess.spaces1[i] = true;
            reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces1",''));
        }else{

            if(sess.concierge[i] === true){
                if(eventObj.source.userId !== sess.username[i]){
                    for(var j = 0; j<sess.username.length; j++){
                        //세션 변경
                        if(sess.username[j] ===  eventObj.source.userId) {
                            //기존 세션
                            i = j;
                            break;
                        }
                    }
                }else{

                }

                if(sess.spaces1[i] === true){
                    if(message.text.indexOf("상업공간") != -1){
                        sess.spacesCategory[i]='1';

                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces2",'1'));

                    } else if(message.text.indexOf("업무공간") != -1){
                        sess.spacesCategory[i]='2';

                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces2",'2'));

                    }else if(message.text.indexOf("주거공간") != -1){
                        sess.spacesCategory[i]='3';

                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces2",'3'));

                    }else if(message.text.indexOf("문화/종교공간") != -1){
                        sess.spacesCategory[i]='4';

                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces2",'4'));

                    }else if(message.text.indexOf("기타공간") != -1){
                        sess.spacesCategory[i]='5';

                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces2",'5'));

                    }else{
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces1",''));
                    }

                    sess.spaces1[i] = false;
                    sess.spaces2[i] = true;

                }else if(sess.spaces2[i] === true) {

                    var result = actionConcierge.getSpaces2(sess.spacesCategory[i],message.text);

                    sess.spacesSubCategory[i] = result;
                    var params = [];
                    params[0] = sess.spacesCategory[i];
                    params[1] = result;
                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaces3",params));

                    sess.spaces2[i] = false;
                    sess.spaces3[i] = true;

                }else if(sess.spaces3[i] === true){
                    var result = actionConcierge.getSpaces3(sess.spacesCategory[i],sess.spacesSubCategory[i],message.text);

                    sess.spacesSpace[i] = result;

                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("specialtyRange",''));
                    sess.spaces3[i] = false;
                    sess.specialtyRangeYN[i] = true;
                }else if(sess.specialtyRangeYN[i] === true){

                    var result = actionConcierge.getSpecialtyRange(message.text);

                    sess.specialtyRange[i] = result;

                    sess.specialtyRangeYN[i] = false;

                    if(sess.specialtyRange[i][0] === 'interiorFull' ||  sess.specialtyRange[i][0] === 'interiorDesign'){
                        sess.spaceBrandingYN[i] = true;
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaceBranding",''));
                    }else{
                        sess.spaceMeasure[i] = true;
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaceMeasure",''));

                    }

                }else if(sess.spaceBrandingYN[i] === true){

                    if(message.text.indexOf("네") != -1){
                        sess.spaceBranding[i] = true;
                    }else{
                        sess.spaceBranding[i] = false;
                    }


                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("spaceMeasure",''));
                    sess.spaceBrandingYN[i] = false;
                    sess.spaceMeasure[i] = true;

                }else if(sess.spaceMeasure[i] === true){

                    var result = actionConcierge.getMeasure(message.text);

                    sess.py[i] = result[0];
                    sess.meter[i] = result[1];

                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("budget",''));
                    sess.spaceMeasure[i] = false;
                    sess.budget[i] = true;

                }else if(sess.budget[i] === true){

                    var result = [];
                    var msg = message.text;
                    msg = msg.trim();
                    var pattern = /\s/g; // 공백여부

                    if(msg.indexOf("~") != -1){
                        result = msg.split("~");
                        sess.budgetMin[i] = result[0];
                        sess.budgetMax[i] = result[1];
                    }else if(msg.match(pattern)){
                        result = msg.split(" ");
                        sess.budgetMin[i] = result[0];
                        sess.budgetMax[i] = result[1];
                    }else if(msg.match(/[0-9]/)){
                        sess.budgetMin[i] = msg;
                        sess.budgetMax[i] = msg;
                    }else{
                        sess.budgetMin[i] = 0;
                        sess.budgetMax[i] = 100000;
                    }

                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("styles",''));
                    sess.budget[i] = false;
                    sess.stylesYN[i] = true;

                }else if(sess.stylesYN[i] === true){

                    var result = actionConcierge.getStyles(message.text);

                    sess.styles[i] = result;

                    var formData = {};
                        formData.specialty = {};
                        formData.specialty.main = "interior";
                        formData.specialty.sub = sess.specialtyRange[i];
                        formData.spaces = {};
                        formData.spaces.category = sess.spacesCategory[i];
                        formData.spaces.subcategory = sess.spacesSubCategory[i];
                        formData.spaces.space = sess.spacesSpace[i];
                        formData.spaceBranding = sess.spaceBranding[i];
                        formData.measure = {};
                        formData.measure.meter = sess.meter[i];
                        formData.measure.py = sess.py[i];
                        formData.budget = {};
                        formData.budget.min = sess.budgetMin[i];
                        formData.budget.max = sess.budgetMax[i];
                        formData.style = sess.styles[i];

                    sess.stylesYN[i] = false;
                    sess.concierge[i] = false;


                    if ( !formData.specialty.main
                        || ( !(formData.specialty.main === 'interior') && !(formData.specialty.main === 'construction')) ) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    if ( !formData.spaces.category || !formData.spaces.space || !formData.spaces.subcategory) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    if ( !formData.specialty.sub.length) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    if ( (!formData.measure.meter) || (!formData.measure.py)
                        || !(formData.measure.meter > -1) ) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    if ( (!formData.budget.min) || (!formData.budget.max)
                        || !(formData.budget.min > -1) || !(formData.budget.max > -1)
                        || (parseInt(formData.budget.min) > parseInt(formData.budget.max)) ) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    if ( !formData.style) {
                        reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionConcierge.getConciergeExpress("error",''));
                        return false;
                    }
                    
                    reply.concierge(formData,eventObj);

                }else{
                    reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionBasic.getBasicExpress());
                }

            }else{
                reply.send(config.CHANNEL_ACCESS_TOKEN, eventObj.replyToken, actionBasic.getBasicExpress());
            }


        }

    }

    response.sendStatus(200);
});
//


/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
    var port = parseInt(val, 10);

    if (isNaN(port)) {
        // named pipe
        return val;
    }

    if (port >= 0) {
        // port number
        return port;
    }

    return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }

    var bind = typeof port === 'string'
        ? 'Pipe ' + port
        : 'Port ' + port;

    // handle specific listen errors with friendly messages
    switch (error.code) {
        case 'EACCES':
            console.error(bind + ' requires elevated privileges');
            process.exit(1);
            break;
        case 'EADDRINUSE':
            console.error(bind + ' is already in use');
            process.exit(1);
            break;
        default:
            throw error;
    }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string'
        ? 'pipe ' + addr
        : 'port ' + addr.port;
    debug('Listening on ' + bind);
}
